<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeTrack - System Journal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400&family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* =============================================
           CSS Variables & Reset
           ============================================= */
        :root {
            --theme-bg: #1a1a2e;
            --theme-text: #eee;
            --theme-accent: #7c3aed;
            --theme-danger: #f87171;
            --theme-border-radius: 12px;
            --theme-padding: 16px;
            --theme-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        /* =============================================
           Base Layout & Typography
           ============================================= */
        body {
            font-family: var(--theme-font);
            max-width: 900px;
            margin: 0 auto;
            padding: 12px;
            background: var(--theme-bg);
            color: var(--theme-text);
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: var(--theme-accent);
            margin-bottom: 12px;
            font-size: 1.5rem;
        }

        h2 {
            margin-top: 0;
            color: var(--theme-accent);
        }

        h3 {
            color: var(--theme-accent);
        }

        .section {
            background: var(--theme-bg);
            border-radius: var(--theme-border-radius);
            padding: var(--theme-padding);
            margin-bottom: 16px;
            border: 1px solid var(--theme-accent);
        }

        .question {
            margin-bottom: 24px;
        }

        .question-label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--theme-accent);
        }

        /* =============================================
           Question Components
           ============================================= */
        .choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .choice-btn {
            padding: 10px 18px;
            border: 2px solid var(--theme-accent);
            background: transparent;
            color: var(--theme-text);
            border-radius: var(--theme-border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: inherit;
        }

        .choice-btn:hover {
            background: var(--theme-accent);
        }

        .choice-btn.selected {
            background: var(--theme-accent);
        }

        /* Scale */
        .scale-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--theme-text);
            opacity: 0.7;
            margin-top: 6px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: var(--theme-text);
            opacity: 0.3;
            border-radius: var(--theme-border-radius);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--theme-accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .scale-value {
            min-width: 36px;
            text-align: center;
            font-weight: 600;
            color: var(--theme-accent);
        }

        /* =============================================
           Form Elements
           ============================================= */
        /* Shared input styles */
        input[type="text"],
        input[type="number"],
        select,
        textarea,
        .markdown-editor {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--theme-accent);
            background: var(--theme-bg);
            color: var(--theme-text);
            border-radius: var(--theme-border-radius);
            font-size: 1rem;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus,
        .markdown-editor:focus {
            outline: none;
        }

        /* Textarea & Markdown Editor - larger padding and height */
        textarea,
        .markdown-editor {
            min-height: 200px;
            padding: 16px;
            line-height: 1.6;
        }

        textarea {
            resize: vertical;
        }

        .markdown-editor {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .markdown-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--theme-text);
            opacity: 0.5;
        }

        /* Markdown syntax styling */
        .md-syntax {
            color: var(--theme-text);
            opacity: 0.4;
        }

        .md-bold {
            font-weight: 600;
            color: var(--theme-text);
        }

        .md-italic {
            font-style: italic;
            color: var(--theme-text);
        }

        .md-code {
            background: var(--theme-bg);
            padding: 2px 4px;
            border-radius: var(--theme-border-radius);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid var(--theme-accent);
        }

        .md-heading {
            font-weight: 600;
            color: var(--theme-accent);
        }

        .md-heading.h1 { font-size: 1.5em; }
        .md-heading.h2 { font-size: 1.3em; }
        .md-heading.h3 { font-size: 1.1em; }

        /* =============================================
           Buttons
           ============================================= */
        .btn-primary {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--theme-accent);
            color: var(--theme-bg);
            border: none;
            border-radius: var(--theme-border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.85;
        }

        .btn-secondary {
            display: inline-block;
            padding: 10px 20px;
            background: transparent;
            color: var(--theme-accent);
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--theme-accent);
            color: var(--theme-bg);
        }

        .btn-danger {
            display: inline-block;
            padding: 8px 16px;
            background: transparent;
            color: var(--theme-danger);
            border: 2px solid var(--theme-danger);
            border-radius: var(--theme-border-radius);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: var(--theme-danger);
            color: var(--theme-bg);
        }

        .btn-small {
            display: inline-block;
            padding: 8px 16px;
            background: transparent;
            color: var(--theme-accent);
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: var(--theme-accent);
            color: var(--theme-bg);
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Success message */
        .success {
            background: var(--theme-accent);
            color: var(--theme-bg);
            padding: 16px;
            border-radius: var(--theme-border-radius);
            text-align: center;
            margin-bottom: 20px;
        }

        /* Entry list */
        .entry-item {
            background: var(--theme-bg);
            padding: 16px;
            border-radius: var(--theme-border-radius);
            margin-bottom: 12px;
            border-left: 4px solid var(--theme-accent);
        }

        .entry-date {
            font-size: 0.85rem;
            color: var(--theme-text);
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .entry-preview {
            color: var(--theme-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entry-answers {
            font-size: 0.9rem;
            color: var(--theme-accent);
            margin-top: 8px;
        }

        /* Question editor */
        .question-card {
            background: var(--theme-bg);
            padding: 16px;
            border-radius: var(--theme-border-radius);
            margin-bottom: 12px;
            border-left: 4px solid var(--theme-accent);
        }

        .question-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .question-card-title {
            font-weight: 600;
            color: var(--theme-accent);
            flex: 1;
        }

        .question-card-type {
            font-size: 0.8rem;
            color: var(--theme-text);
            opacity: 0.7;
            background: var(--theme-bg);
            border: 1px solid var(--theme-accent);
            padding: 4px 8px;
            border-radius: var(--theme-border-radius);
            margin-left: 12px;
        }

        .question-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--theme-accent);
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row > * {
            flex: 1;
        }

        .options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .option-tag {
            background: var(--theme-bg);
            border: 1px solid var(--theme-accent);
            padding: 6px 12px;
            border-radius: var(--theme-border-radius);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-remove {
            cursor: pointer;
            color: var(--theme-danger);
            font-weight: bold;
        }

        .add-option-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .add-option-row input {
            flex: 1;
        }

        /* Export section */
        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        .text-muted {
            color: var(--theme-text);
            opacity: 0.6;
        }

        .button-row {
            display: flex;
            gap: 12px;
        }

        .button-row .btn-primary {
            flex: 1;
        }

        /* =============================================
           Modals
           ============================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--theme-bg);
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-top: 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* =============================================
           Markdown Content Display
           ============================================= */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: var(--theme-accent);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.3em; }
        .markdown-content h3 { font-size: 1.1em; }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
        }

        .markdown-content code {
            background: var(--theme-bg);
            border: 1px solid var(--theme-accent);
            padding: 2px 6px;
            border-radius: var(--theme-border-radius);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: var(--theme-bg);
            border: 1px solid var(--theme-accent);
            padding: 12px;
            border-radius: var(--theme-border-radius);
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content pre code {
            padding: 0;
            background: none;
            border: none;
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--theme-accent);
            padding-left: 16px;
            margin: 1em 0;
            color: var(--theme-text);
            opacity: 0.8;
            font-style: italic;
        }

        .markdown-content a {
            color: var(--theme-accent);
            text-decoration: underline;
        }

        .markdown-content strong {
            font-weight: 600;
            color: var(--theme-text);
        }

        .markdown-content em {
            font-style: italic;
            color: var(--theme-text);
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid var(--theme-accent);
            margin: 2em 0;
        }

        /* =============================================
           Theme Selection UI
           ============================================= */
        .theme-selection-container {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .theme-grid-wrapper {
            flex: 1;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .theme-card {
            aspect-ratio: 1;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .theme-card:hover {
            transform: scale(1.03);
        }

        .theme-card.selected {
            outline: 2px solid var(--theme-accent);
            outline-offset: 2px;
        }

        .theme-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--theme-accent);
            color: var(--theme-bg);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .theme-sample-text {
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .theme-sample-accent {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            width: fit-content;
        }

        .sidebar-columns {
            display: flex;
            gap: 16px;
        }

        .locks-sidebar {
            width: 120px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .locks-sidebar h3 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
        }

        .property-editor {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .property-editor label {
            font-size: 0.75rem;
            color: var(--theme-text);
            opacity: 0.7;
        }

        /* Color swatch trigger */
        .color-swatch {
            width: 100%;
            height: 36px;
            padding: 0;
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            cursor: pointer;
            display: block;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .color-swatch:hover, .color-swatch:focus {
            transform: scale(1.04);
            outline: 2px solid var(--theme-accent);
            outline-offset: 2px;
        }

        /* Color picker overlay + panel */
        #color-picker-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        #color-picker-panel {
            background: var(--theme-bg);
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            padding: 20px;
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        #cp-title {
            margin: 0;
            font-size: 1rem;
            color: var(--theme-accent);
            text-align: center;
        }
        #cp-preview {
            width: 100%;
            height: 52px;
            border-radius: calc(var(--theme-border-radius) / 2);
            border: 1px solid rgba(128,128,128,0.35);
        }
        .cp-row {
            display: grid;
            grid-template-columns: 18px 1fr 52px;
            align-items: center;
            gap: 10px;
        }
        .cp-hex-row {
            display: grid;
            grid-template-columns: 18px 1fr;
            align-items: center;
            gap: 10px;
        }
        .cp-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--theme-text);
            opacity: 0.65;
            text-align: center;
        }
        /* Slider track */
        .cp-row input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 22px;
            border-radius: 11px;
            outline: none;
            cursor: pointer;
            border: 1px solid rgba(128,128,128,0.3);
            padding: 0;
        }
        .cp-row input[type="range"]::-webkit-slider-runnable-track {
            border-radius: 11px;
            height: 22px;
        }
        .cp-row input[type="range"]::-moz-range-track {
            border-radius: 11px;
            height: 22px;
            border: 1px solid rgba(128,128,128,0.3);
        }
        /* Slider thumb ‚Äî large for touch */
        .cp-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid rgba(0,0,0,0.45);
            box-shadow: 0 1px 5px rgba(0,0,0,0.45);
            cursor: pointer;
            margin-top: -3px;
        }
        .cp-row input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid rgba(0,0,0,0.45);
            box-shadow: 0 1px 5px rgba(0,0,0,0.45);
            cursor: pointer;
        }
        /* Number inputs */
        .cp-row input[type="number"] {
            width: 100%;
            padding: 5px 4px;
            font-size: 0.85rem;
            background: var(--theme-bg);
            color: var(--theme-text);
            border: 2px solid var(--theme-accent);
            border-radius: 6px;
            text-align: center;
            -moz-appearance: textfield;
        }
        .cp-row input[type="number"]::-webkit-outer-spin-button,
        .cp-row input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
        /* Hex input */
        #cp-hex {
            padding: 8px 10px;
            font-size: 0.9rem;
            font-family: monospace;
            background: var(--theme-bg);
            color: var(--theme-text);
            border: 2px solid var(--theme-accent);
            border-radius: 6px;
            width: 100%;
            text-align: center;
            letter-spacing: 0.05em;
        }
        #cp-done {
            padding: 12px;
            background: var(--theme-accent);
            color: var(--theme-bg);
            border: none;
            border-radius: var(--theme-border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        #cp-done:hover { opacity: 0.85; }

        /* Font picker trigger */
        #font-pick-trigger {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.85rem;
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            background: var(--theme-bg);
            color: var(--theme-text);
            cursor: pointer;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity 0.15s;
        }
        #font-pick-trigger:hover { opacity: 0.8; }

        /* Font picker modal */
        #font-picker-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        #font-picker-panel {
            background: var(--theme-bg);
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            padding: 20px;
            width: 100%;
            max-width: 440px;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #fp-title {
            margin: 0;
            font-size: 1rem;
            color: var(--theme-accent);
            text-align: center;
            flex-shrink: 0;
        }
        #fp-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            flex-shrink: 0;
        }
        .fp-cat {
            padding: 5px 13px;
            border: 2px solid var(--theme-accent);
            background: transparent;
            color: var(--theme-accent);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .fp-cat.active, .fp-cat:hover {
            background: var(--theme-accent);
            color: var(--theme-bg);
        }
        #fp-font-list {
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-height: 0;
        }
        .fp-font-btn {
            padding: 10px 14px;
            border: 2px solid transparent;
            border-radius: var(--theme-border-radius);
            background: rgba(128, 128, 128, 0.1);
            color: var(--theme-text);
            cursor: pointer;
            text-align: left;
            transition: border-color 0.15s, background 0.15s;
            width: 100%;
        }
        .fp-font-btn:hover {
            border-color: var(--theme-accent);
            background: rgba(128, 128, 128, 0.2);
        }
        .fp-font-btn.selected {
            border-color: var(--theme-accent);
            background: rgba(128, 128, 128, 0.25);
        }
        .fp-font-name {
            font-size: 1rem;
            display: block;
        }
        .fp-font-sample {
            font-size: 0.8rem;
            opacity: 0.5;
            display: block;
            margin-top: 3px;
        }
        #fp-done {
            padding: 12px;
            background: var(--theme-accent);
            color: var(--theme-bg);
            border: none;
            border-radius: var(--theme-border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.15s;
            flex-shrink: 0;
        }
        #fp-done:hover { opacity: 0.85; }

        .property-editor input[type="range"] {
            width: 100%;
            height: 6px;
            opacity: 1;
            background: var(--theme-text);
        }

        .property-editor select {
            width: 100%;
            padding: 4px;
            font-size: 0.75rem;
            border: 2px solid var(--theme-accent);
            border-radius: var(--theme-border-radius);
            background: var(--theme-bg);
            color: var(--theme-text);
        }

        .property-btn {
            padding: 8px 12px;
            border: 2px solid var(--theme-accent);
            background: transparent;
            color: var(--theme-accent);
            border-radius: var(--theme-border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
            width: 100%;
        }

        .property-btn:hover {
            background: var(--theme-accent);
            color: var(--theme-bg);
        }

        .property-btn.locked {
            background: var(--theme-accent);
            color: var(--theme-bg);
        }

        .property-btn.locked::before {
            content: 'üîí ';
        }

        /* =============================================
           Responsive Styles
           ============================================= */
        @media (max-width: 768px) {
            /* Theme selection - stack sidebar below grid */
            .theme-selection-container {
                flex-direction: column;
            }

            .sidebar-columns {
                flex-direction: row;
                justify-content: center;
                width: 100%;
            }

            .locks-sidebar {
                width: auto;
                flex: 1;
                max-width: 200px;
            }

            /* Theme grid - 3 columns on tablet */
            .theme-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            /* Form rows - allow wrapping */
            .form-row {
                flex-wrap: wrap;
            }

            .form-row > * {
                min-width: 200px;
            }

            /* Reduce landing page padding */
            #landing-view .section {
                padding: 40px 20px !important;
            }
        }

        @media (max-width: 480px) {
            /* Smaller body padding */
            body {
                padding: 8px;
            }

            h1 {
                font-size: 1.3rem;
            }

            /* Navigation - full width buttons */
            .nav {
                flex-direction: column;
                gap: 6px;
            }

            .nav .btn-secondary {
                width: 100%;
                text-align: center;
            }

            /* Theme grid - 2 columns on mobile */
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            /* Stack sidebars vertically on small screens */
            .sidebar-columns {
                flex-direction: column;
                align-items: stretch;
            }

            .locks-sidebar {
                max-width: none;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .locks-sidebar h3 {
                width: 100%;
                text-align: center;
            }

            .property-btn {
                flex: 1;
                min-width: 80px;
            }

            .property-editor {
                flex: 1;
                min-width: 100px;
            }

            /* Larger touch targets for buttons */
            .btn-primary {
                padding: 14px;
                font-size: 1rem;
            }

            .btn-secondary {
                padding: 12px 16px;
                min-height: 44px;
            }

            .btn-small, .btn-danger {
                padding: 10px 14px;
                min-height: 44px;
            }

            .choice-btn {
                padding: 12px 16px;
                min-height: 44px;
            }

            /* Form row - stack on mobile */
            .form-row {
                flex-direction: column;
            }

            .form-row > * {
                min-width: 100%;
            }

            /* Reduce section padding */
            .section {
                padding: 12px;
            }

            /* Smaller textarea on mobile */
            textarea,
            .markdown-editor {
                min-height: 150px;
            }

            /* Modal adjustments */
            .modal-overlay {
                padding: 10px;
            }

            .modal {
                padding: 16px;
                max-width: 100%;
            }

            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }

            .modal-actions button {
                width: 100%;
            }

            /* Question card actions - wrap buttons */
            .question-card-actions {
                flex-wrap: wrap;
            }

            /* Entry items - larger touch target */
            .entry-item {
                padding: 14px;
            }

            /* Landing page */
            #landing-view .section {
                padding: 30px 16px !important;
            }

            #landing-view h2 {
                font-size: 1.3rem !important;
                margin-bottom: 24px !important;
            }

            /* Button rows - stack on mobile */
            .button-row {
                flex-direction: column;
            }

            .button-row button {
                width: 100%;
            }
        }

        /* Focus visibility for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        .markdown-editor:focus-visible {
            outline: 2px solid var(--theme-accent);
            outline-offset: 2px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <h1>WeTrack</h1>

    <nav class="nav">
        <button class="btn-secondary" onclick="showView('landing')">Home</button>
        <button class="btn-secondary" onclick="showView('history')">View History</button>
        <button class="btn-secondary" onclick="showView('questions')">Edit Questions</button>
        <button class="btn-secondary" onclick="showView('export')">Export Data</button>
    </nav>

    <!-- Landing Page -->
    <div id="landing-view">
        <div class="section" style="text-align: center; padding: 60px 24px;">
            <h2 style="font-size: 1.5rem; margin-bottom: 40px;">Welcome to WeTrack</h2>
            <button class="btn-primary" onclick="startNewEntry()" style="max-width: 300px; margin: 0 auto;">Start an Entry</button>
        </div>
    </div>

    <!-- Theme Selection View -->
    <div id="theme-view" class="hidden">
        <div class="section">
            <h2 style="margin-bottom: 8px;">Choose Your Theme</h2>
            <p class="text-muted" style="margin-bottom: 16px; font-size: 0.9rem;">
                <span id="theme-instruction">Select one or more themes</span>
            </p>

            <div class="theme-selection-container">
                <div class="theme-grid-wrapper">
                    <div id="theme-grid" class="theme-grid"></div>
                </div>

                <div class="sidebar-columns">
                    <div id="locked-properties" class="locks-sidebar">
                        <h3>Lock</h3>
                        <div id="property-locks"></div>
                    </div>

                    <div id="edit-properties" class="locks-sidebar">
                        <h3>Edit</h3>
                        <div id="property-editors">
                            <div class="property-editor">
                                <label>Background</label>
                                <button class="color-swatch" id="swatch-bgColor" onclick="openColorPicker('bgColor')" title="Edit background colour"></button>
                            </div>
                            <div class="property-editor">
                                <label>Text</label>
                                <button class="color-swatch" id="swatch-textColor" onclick="openColorPicker('textColor')" title="Edit text colour"></button>
                            </div>
                            <div class="property-editor">
                                <label>Accent</label>
                                <button class="color-swatch" id="swatch-accentColor" onclick="openColorPicker('accentColor')" title="Edit accent colour"></button>
                            </div>
                            <div class="property-editor">
                                <label>Corners</label>
                                <input type="range" id="edit-radius" min="0" max="24" onchange="editProperty('borderRadius', this.value + 'px')">
                            </div>
                            <div class="property-editor">
                                <label>Spacing</label>
                                <input type="range" id="edit-padding" min="4" max="32" onchange="editProperty('padding', this.value + 'px')">
                            </div>
                            <div class="property-editor">
                                <label>Font</label>
                                <button id="font-pick-trigger" onclick="openFontPicker()" title="Choose font">Font</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-row" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn-secondary" onclick="goBackThemes()" id="back-themes-btn" style="display: none;">‚Üê Back</button>
                <button class="btn-primary" onclick="confirmThemeSelection()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Entry View -->
    <div id="entry-view" class="hidden">
        <!-- Step 1: Questions -->
        <div id="questions-step">
            <div class="section">
                <h2>Check-In Questions</h2>
                <div id="questions-container"></div>
            </div>
            <button class="btn-primary" onclick="goToJournal()">Continue to Journal</button>
        </div>

        <!-- Step 2: Journal -->
        <div id="journal-step" class="hidden">
            <div class="section">
                <h2 style="margin-bottom: 16px;">Journal Entry</h2>
                <div id="journal-text"
                     class="markdown-editor"
                     contenteditable="true"
                     data-placeholder="Write your thoughts here... (Markdown supported)"
                     oninput="handleMarkdownInput()"
                     onpaste="handlePaste(event)"></div>
            </div>
            <div class="button-row">
                <button class="btn-secondary" onclick="backToQuestions()">‚Üê Back to Questions</button>
                <button class="btn-primary" onclick="saveEntry()">Save Entry</button>
            </div>
            <div id="success-message" class="success hidden">Entry saved successfully!</div>
        </div>
    </div>

    <!-- History View -->
    <div id="history-view" class="hidden">
        <div class="section">
            <h2>Past Entries</h2>
            <div id="entries-list"></div>
        </div>
    </div>

    <!-- Entry Detail View -->
    <div id="detail-view" class="hidden">
        <div class="section">
            <button class="btn-secondary" onclick="showView('history')" style="margin-bottom: 16px;">&larr; Back</button>
            <div id="entry-detail"></div>
        </div>
    </div>

    <!-- Questions Editor View -->
    <div id="questions-view" class="hidden">
        <div class="section">
            <h2>Manage Questions</h2>
            <p class="text-muted" style="margin-bottom: 20px;">Customize the check-in questions asked before each journal entry.</p>
            <div id="questions-list"></div>
            <button class="btn-primary" onclick="openAddQuestionModal()" style="margin-top: 16px;">+ Add New Question</button>
        </div>
    </div>

    <!-- Export View -->
    <div id="export-view" class="hidden">
        <div class="section">
            <h2>Export Your Data</h2>
            <p class="text-muted" style="margin-bottom: 20px;">Download your entries and question configuration.</p>

            <h3>Export Entries</h3>
            <div class="export-buttons" style="margin-bottom: 24px;">
                <button class="btn-secondary" onclick="exportEntriesJSON()">Export as JSON</button>
                <button class="btn-secondary" onclick="exportEntriesCSV()">Export as CSV</button>
            </div>

            <h3>Export Questions</h3>
            <div class="export-buttons" style="margin-bottom: 24px;">
                <button class="btn-secondary" onclick="exportQuestionsJSON()">Export Questions (JSON)</button>
            </div>

            <h3>Import Data</h3>
            <div class="form-group">
                <label>Import Entries (JSON)</label>
                <input type="file" id="import-entries-file" accept=".json" onchange="importEntriesJSON(event)">
            </div>
            <div class="form-group">
                <label>Import Questions (JSON)</label>
                <input type="file" id="import-questions-file" accept=".json" onchange="importQuestionsJSON(event)">
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div id="question-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 id="modal-title">Add Question</h2>

            <div class="form-group">
                <label>Question Text</label>
                <input type="text" id="q-text" placeholder="Enter your question...">
            </div>

            <div class="form-group">
                <label>Question Type</label>
                <select id="q-type" onchange="updateTypeOptions()">
                    <option value="text">Text Input</option>
                    <option value="scale">Number Scale</option>
                    <option value="choice">Multiple Choice</option>
                </select>
            </div>

            <!-- Scale options -->
            <div id="scale-options" class="hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>Min Value</label>
                        <input type="number" id="q-min" value="1">
                    </div>
                    <div class="form-group">
                        <label>Max Value</label>
                        <input type="number" id="q-max" value="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Min Label</label>
                        <input type="text" id="q-min-label" placeholder="e.g., Very low">
                    </div>
                    <div class="form-group">
                        <label>Max Label</label>
                        <input type="text" id="q-max-label" placeholder="e.g., Very high">
                    </div>
                </div>
            </div>

            <!-- Choice options -->
            <div id="choice-options" class="hidden">
                <div class="form-group">
                    <label>Options</label>
                    <div id="options-container" class="options-list"></div>
                    <div class="add-option-row">
                        <input type="text" id="new-option" placeholder="Add an option...">
                        <button class="btn-small" onclick="addOption()">Add</button>
                    </div>
                </div>
            </div>

            <!-- Text options -->
            <div id="text-options">
                <div class="form-group">
                    <label>Placeholder Text</label>
                    <input type="text" id="q-placeholder" placeholder="Optional placeholder...">
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeQuestionModal()">Cancel</button>
                <button class="btn-primary" onclick="saveQuestion()" style="width: auto; padding: 12px 24px;">Save Question</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <h2>Confirm Delete</h2>
            <p id="confirm-message">Are you sure you want to delete this?</p>
            <div class="form-group" style="margin-top: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="skip-confirms-checkbox" style="width: auto;">
                    <span>Don't ask again for 5 minutes</span>
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="cancelConfirm()">Cancel</button>
                <button class="btn-danger" onclick="proceedConfirm()" style="padding: 12px 24px;">Delete</button>
            </div>
        </div>
    </div>

    <script>
        /* =============================================
           Constants & Configuration
           ============================================= */
        const STORAGE_KEYS = {
            ENTRIES: 'wetrack-entries',
            QUESTIONS: 'wetrack-questions'
        };

        // Timing constants
        const SKIP_CONFIRMS_DURATION_MS = 5 * 60 * 1000; // 5 minutes
        const MARKDOWN_DEBOUNCE_MS = 150; // Debounce delay for markdown rendering

        // Default questions
        const defaultQuestions = [
            {
                id: 'energy',
                text: 'How is your energy level right now?',
                type: 'scale',
                min: 1,
                max: 10,
                minLabel: 'Very low',
                maxLabel: 'Very high'
            },
            {
                id: 'mood',
                text: 'How would you describe your current mood?',
                type: 'choice',
                options: ['Calm', 'Anxious', 'Happy', 'Sad', 'Angry', 'Numb', 'Mixed']
            },
            {
                id: 'clarity',
                text: 'How clear does your thinking feel?',
                type: 'scale',
                min: 1,
                max: 10,
                minLabel: 'Foggy',
                maxLabel: 'Crystal clear'
            },
            {
                id: 'name',
                text: 'What name feels right to go by today?',
                type: 'text',
                placeholder: 'Enter a name or leave blank'
            },
            {
                id: 'age',
                text: 'If you had to pick an age that feels right, what would it be?',
                type: 'text',
                placeholder: 'A number, range, or description'
            },
            {
                id: 'front',
                text: 'How present/fronting do you feel?',
                type: 'scale',
                min: 1,
                max: 10,
                minLabel: 'Barely here',
                maxLabel: 'Fully present'
            }
        ];

        /* =============================================
           State Variables
           ============================================= */
        let questions = [];
        let currentAnswers = {};
        let editingQuestionId = null;
        let tempOptions = [];

        // Theme state
        let currentThemes = [];
        let selectedThemeIndices = [];
        let themeHistory = [];
        let currentTheme = null;
        let lockedProperties = {};
        let lastSelectedThemeIndex = null;

        // Confirmation state
        let skipConfirmsUntil = 0;
        let pendingConfirmAction = null;

        // Markdown editor state
        let markdownDebounceTimer = null;

        /* =============================================
           Security Utilities
           ============================================= */
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function sanitizeHtml(html) {
            // Remove script tags and their contents
            html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            // Remove event handlers (onclick, onerror, onload, etc.)
            html = html.replace(/\s+on\w+\s*=\s*["'][^"']*["']/gi, '');
            html = html.replace(/\s+on\w+\s*=\s*[^\s>]+/gi, '');
            // Remove javascript: URLs
            html = html.replace(/href\s*=\s*["']javascript:[^"']*["']/gi, 'href="#"');
            html = html.replace(/src\s*=\s*["']javascript:[^"']*["']/gi, 'src=""');
            return html;
        }

        /* =============================================
           Storage Utilities
           ============================================= */
        function safeGetStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (err) {
                console.error('Error reading from localStorage:', err);
                return defaultValue;
            }
        }

        function safeSetStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (err) {
                console.error('Error writing to localStorage:', err);
                if (err.name === 'QuotaExceededError') {
                    alert('Storage is full. Please export and delete some old entries.');
                }
                return false;
            }
        }

        /* =============================================
           Confirmation Dialog
           ============================================= */
        function showConfirm(message, onConfirm) {
            // Check if we're in "skip confirms" mode
            if (Date.now() < skipConfirmsUntil) {
                onConfirm();
                return;
            }

            pendingConfirmAction = onConfirm;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('skip-confirms-checkbox').checked = false;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function proceedConfirm() {
            if (document.getElementById('skip-confirms-checkbox').checked) {
                skipConfirmsUntil = Date.now() + SKIP_CONFIRMS_DURATION_MS;
            }
            document.getElementById('confirm-modal').classList.add('hidden');
            if (pendingConfirmAction) {
                pendingConfirmAction();
                pendingConfirmAction = null;
            }
        }

        function cancelConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingConfirmAction = null;
        }

        /* =============================================
           Theme Generation & Selection
           ============================================= */
        const fontFamilies = [
            'Georgia, serif',
            "'Courier New', monospace",
            'Arial, sans-serif',
            'Verdana, sans-serif',
            "'Times New Roman', serif",
            "'Comic Sans MS', cursive",
            'system-ui, sans-serif',
            "'Trebuchet MS', sans-serif",
            "'Lexend', sans-serif",
            "'Atkinson Hyperlegible', sans-serif"
        ];

        function generateInitialThemes() {
            const themes = [];
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);

            // Get themes from last 10 entries
            const historicalThemes = entries
                .slice(0, 10)
                .map(e => e.theme)
                .filter(t => t); // Filter out entries without themes

            if (historicalThemes.length > 0) {
                // Generate 8 random themes
                for (let i = 0; i < 8; i++) {
                    themes.push(generateRandomTheme());
                }
                // Generate 8 themes parented by historical themes
                for (let i = 0; i < 8; i++) {
                    const parent1 = historicalThemes[Math.floor(Math.random() * historicalThemes.length)];
                    const parent2 = historicalThemes[Math.floor(Math.random() * historicalThemes.length)];
                    themes.push(blendThemes(parent1, parent2));
                }
            } else {
                // No history - generate 16 random themes
                for (let i = 0; i < 16; i++) {
                    themes.push(generateRandomTheme());
                }
            }

            return themes;
        }

        function generateRandomTheme() {
            const hue = Math.random() * 360;
            const saturation = 20 + Math.random() * 40;
            const lightness = 15 + Math.random() * 10;

            return {
                bgColor: `hsl(${hue}, ${saturation}%, ${lightness}%)`,
                textColor: `hsl(${hue}, ${saturation * 0.3}%, ${70 + Math.random() * 20}%)`,
                accentColor: `hsl(${(hue + 30 + Math.random() * 60) % 360}, ${50 + Math.random() * 30}%, ${50 + Math.random() * 20}%)`,
                borderRadius: Math.floor(Math.random() * 20) + 'px',
                padding: Math.floor(8 + Math.random() * 16) + 'px',
                font: fontFamilies[Math.floor(Math.random() * fontFamilies.length)]
            };
        }

        function generateChildThemes(parentThemes) {
            const themes = [];
            for (let i = 0; i < 16; i++) {
                // Blend random pairs of parent themes
                const parent1 = parentThemes[Math.floor(Math.random() * parentThemes.length)];
                const parent2 = parentThemes[Math.floor(Math.random() * parentThemes.length)];
                const blended = blendThemes(parent1, parent2);

                // Apply locked properties
                Object.keys(lockedProperties).forEach(key => {
                    blended[key] = lockedProperties[key];
                });

                themes.push(blended);
            }
            return themes;
        }

        function blendThemes(theme1, theme2) {
            // Parse HSL values
            const parseHSL = (hslStr) => {
                const match = hslStr.match(/hsl\(([^,]+),\s*([^,]+)%,\s*([^)]+)%\)/);
                return match ? [parseFloat(match[1]), parseFloat(match[2]), parseFloat(match[3])] : [0, 0, 0];
            };

            const [h1, s1, l1] = parseHSL(theme1.bgColor);
            const [h2, s2, l2] = parseHSL(theme2.bgColor);
            const [th1, ts1, tl1] = parseHSL(theme1.textColor);
            const [th2, ts2, tl2] = parseHSL(theme2.textColor);
            const [ah1, as1, al1] = parseHSL(theme1.accentColor);
            const [ah2, as2, al2] = parseHSL(theme2.accentColor);

            // More varied blending with random ratios instead of 50/50
            const ratio = 0.2 + Math.random() * 0.6; // Random ratio between 0.2 and 0.8
            const blend = (a, b, variation) => {
                // 20% chance to completely randomize this property
                if (Math.random() < 0.2) {
                    return a + (Math.random() - 0.5) * variation * 2;
                }
                return a * ratio + b * (1 - ratio) + (Math.random() - 0.5) * variation;
            };

            return {
                bgColor: `hsl(${blend(h1, h2, 60)}, ${blend(s1, s2, 40)}%, ${blend(l1, l2, 15)}%)`,
                textColor: `hsl(${blend(th1, th2, 60)}, ${blend(ts1, ts2, 40)}%, ${blend(tl1, tl2, 20)}%)`,
                accentColor: `hsl(${blend(ah1, ah2, 80)}, ${blend(as1, as2, 50)}%, ${blend(al1, al2, 30)}%)`,
                borderRadius: Math.max(0, Math.floor(blend(parseInt(theme1.borderRadius), parseInt(theme2.borderRadius), 15))) + 'px',
                padding: Math.max(8, Math.floor(blend(parseInt(theme1.padding), parseInt(theme2.padding), 12))) + 'px',
                font: Math.random() < 0.7 ? (Math.random() > 0.5 ? theme1.font : theme2.font) : fontFamilies[Math.floor(Math.random() * fontFamilies.length)]
            };
        }

        function renderThemeGrid() {
            const container = document.getElementById('theme-grid');
            container.innerHTML = '';

            currentThemes.forEach((theme, index) => {
                const card = document.createElement('div');
                card.className = 'theme-card';
                if (selectedThemeIndices.includes(index)) {
                    card.classList.add('selected');
                }

                // Apply locked values visually, otherwise use theme's own values
                const displayBg = lockedProperties.bgColor !== undefined ? lockedProperties.bgColor : theme.bgColor;
                const displayText = lockedProperties.textColor !== undefined ? lockedProperties.textColor : theme.textColor;
                const displayAccent = lockedProperties.accentColor !== undefined ? lockedProperties.accentColor : theme.accentColor;
                const displayRadius = lockedProperties.borderRadius !== undefined ? lockedProperties.borderRadius : theme.borderRadius;
                const displayPadding = lockedProperties.padding !== undefined ? lockedProperties.padding : theme.padding;
                const displayFont = lockedProperties.font !== undefined ? lockedProperties.font : theme.font;

                card.style.backgroundColor = displayBg;
                card.style.color = displayText;
                card.style.borderRadius = displayRadius;
                card.style.padding = displayPadding;
                card.style.fontFamily = displayFont;

                card.innerHTML = `
                    <div class="theme-sample-text" style="color: ${displayText} !important; font-family: ${displayFont} !important;">The quick brown fox</div>
                    <div class="theme-sample-accent" style="background: ${displayAccent} !important; color: ${displayBg} !important; font-family: ${displayFont} !important;">
                        Accent
                    </div>
                `;

                card.onclick = () => toggleThemeSelection(index);
                container.appendChild(card);
            });
        }

        function toggleThemeSelection(index) {
            const pos = selectedThemeIndices.indexOf(index);
            if (pos > -1) {
                selectedThemeIndices.splice(pos, 1);
            } else {
                selectedThemeIndices.push(index);
                // Track the most recently selected theme
                lastSelectedThemeIndex = index;
            }
            renderThemeGrid();
            renderPropertyLocks();
            updateEditorValues();
        }

        function renderPropertyLocks() {
            const container = document.getElementById('property-locks');

            if (selectedThemeIndices.length === 0) {
                container.innerHTML = '<p class="text-muted" style="font-size: 0.85rem;">Select themes to lock properties</p>';
                return;
            }

            container.innerHTML = '';

            const selectedThemes = selectedThemeIndices.map(i => currentThemes[i]);
            const firstTheme = selectedThemes[0];

            const properties = [
                { key: 'bgColor', label: 'Background' },
                { key: 'textColor', label: 'Text' },
                { key: 'accentColor', label: 'Accent' },
                { key: 'font', label: 'Font' },
                { key: 'borderRadius', label: 'Corners' },
                { key: 'padding', label: 'Spacing' }
            ];

            properties.forEach(prop => {
                const btn = document.createElement('button');
                btn.className = 'property-btn';
                if (lockedProperties[prop.key] !== undefined) {
                    btn.classList.add('locked');
                }

                btn.textContent = prop.label;
                btn.onclick = () => togglePropertyLock(prop.key, firstTheme[prop.key]);
                container.appendChild(btn);
            });
        }

        function togglePropertyLock(key, value) {
            if (lockedProperties[key] !== undefined) {
                delete lockedProperties[key];
            } else {
                lockedProperties[key] = value;
            }
            renderPropertyLocks();
            renderThemeGrid();
            updateEditorValues();
        }

        function editProperty(key, value) {
            // Update the current theme or create one from first selected
            if (!currentTheme) {
                if (selectedThemeIndices.length > 0) {
                    currentTheme = { ...currentThemes[selectedThemeIndices[0]] };
                } else {
                    currentTheme = { ...currentThemes[0] };
                }
            }

            // Convert hex to HSL for color properties
            if (key === 'bgColor' || key === 'textColor' || key === 'accentColor') {
                value = hexToHsl(value);
            }

            currentTheme[key] = value;
            lockedProperties[key] = value;
            applyTheme(currentTheme);
            renderPropertyLocks();
            renderThemeGrid();
        }

        function hexToHsl(hex) {
            let r = parseInt(hex.slice(1, 3), 16) / 255;
            let g = parseInt(hex.slice(3, 5), 16) / 255;
            let b = parseInt(hex.slice(5, 7), 16) / 255;

            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            return `hsl(${Math.round(h * 360)}, ${Math.round(s * 100)}%, ${Math.round(l * 100)}%)`;
        }

        function hslToHex(hsl) {
            const match = hsl.match(/hsl\(([^,]+),\s*([^,]+)%,\s*([^)]+)%\)/);
            if (!match) return '#000000';
            let [, h, s, l] = match.map(Number);
            s /= 100; l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        /* =============================================
           Custom Colour Picker
           ============================================= */
        let activeColorKey = null;
        let cpH = 0, cpS = 0, cpL = 0;

        const CP_LABELS = { bgColor: 'Background', textColor: 'Text', accentColor: 'Accent' };

        function parseHslStr(hsl) {
            const m = hsl.match(/hsl\(([^,]+),\s*([^,]+)%,\s*([^)]+)%\)/);
            if (!m) return { h: 0, s: 0, l: 50 };
            return { h: parseFloat(m[1]), s: parseFloat(m[2]), l: parseFloat(m[3]) };
        }

        function openColorPicker(key) {
            activeColorKey = key;
            const baseTheme = (lastSelectedThemeIndex !== null && currentThemes[lastSelectedThemeIndex])
                ? currentThemes[lastSelectedThemeIndex]
                : (selectedThemeIndices.length > 0 ? currentThemes[selectedThemeIndices[0]] : currentThemes[0]);
            const hslStr = (lockedProperties[key] !== undefined)
                ? lockedProperties[key]
                : (baseTheme ? baseTheme[key] : 'hsl(0, 0%, 50%)');
            const { h, s, l } = parseHslStr(hslStr || 'hsl(0, 0%, 50%)');
            cpH = h; cpS = s; cpL = l;
            document.getElementById('cp-title').textContent = CP_LABELS[key] || 'Colour';
            syncPickerUI();
            document.getElementById('color-picker-overlay').style.display = 'flex';
        }

        function closeColorPicker() {
            document.getElementById('color-picker-overlay').style.display = 'none';
        }

        function syncPickerUI() {
            document.getElementById('cp-hue').value = cpH;
            document.getElementById('cp-sat').value = cpS;
            document.getElementById('cp-lit').value = cpL;
            document.getElementById('cp-hue-num').value = Math.round(cpH);
            document.getElementById('cp-sat-num').value = Math.round(cpS);
            document.getElementById('cp-lit-num').value = Math.round(cpL);
            const hex = hslToHex(`hsl(${cpH}, ${cpS}%, ${cpL}%)`);
            document.getElementById('cp-hex').value = hex;
            document.getElementById('cp-preview').style.background = hex;
            updateSliderGradients();
            applyPickerColor();
        }

        function updateColorFromSliders() {
            cpH = parseFloat(document.getElementById('cp-hue').value);
            cpS = parseFloat(document.getElementById('cp-sat').value);
            cpL = parseFloat(document.getElementById('cp-lit').value);
            document.getElementById('cp-hue-num').value = Math.round(cpH);
            document.getElementById('cp-sat-num').value = Math.round(cpS);
            document.getElementById('cp-lit-num').value = Math.round(cpL);
            const hex = hslToHex(`hsl(${cpH}, ${cpS}%, ${cpL}%)`);
            document.getElementById('cp-hex').value = hex;
            document.getElementById('cp-preview').style.background = hex;
            updateSliderGradients();
            applyPickerColor();
        }

        function updateColorFromNumbers() {
            const hNum = parseFloat(document.getElementById('cp-hue-num').value);
            const sNum = parseFloat(document.getElementById('cp-sat-num').value);
            const lNum = parseFloat(document.getElementById('cp-lit-num').value);
            if (!isNaN(hNum)) cpH = Math.min(360, Math.max(0, hNum));
            if (!isNaN(sNum)) cpS = Math.min(100, Math.max(0, sNum));
            if (!isNaN(lNum)) cpL = Math.min(100, Math.max(0, lNum));
            document.getElementById('cp-hue').value = cpH;
            document.getElementById('cp-sat').value = cpS;
            document.getElementById('cp-lit').value = cpL;
            const hex = hslToHex(`hsl(${cpH}, ${cpS}%, ${cpL}%)`);
            document.getElementById('cp-hex').value = hex;
            document.getElementById('cp-preview').style.background = hex;
            updateSliderGradients();
            applyPickerColor();
        }

        function updateColorFromHex() {
            const hex = document.getElementById('cp-hex').value.trim();
            if (!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
            const { h, s, l } = parseHslStr(hexToHsl(hex));
            cpH = h; cpS = s; cpL = l;
            document.getElementById('cp-hue').value = cpH;
            document.getElementById('cp-sat').value = cpS;
            document.getElementById('cp-lit').value = cpL;
            document.getElementById('cp-hue-num').value = Math.round(cpH);
            document.getElementById('cp-sat-num').value = Math.round(cpS);
            document.getElementById('cp-lit-num').value = Math.round(cpL);
            document.getElementById('cp-preview').style.background = hex;
            updateSliderGradients();
            applyPickerColor();
        }

        function updateSliderGradients() {
            const h = cpH, s = cpS, l = cpL;
            // Hue: rainbow strip at current S and L
            document.getElementById('cp-hue').style.background =
                `linear-gradient(to right, hsl(0,${s}%,${l}%), hsl(60,${s}%,${l}%), hsl(120,${s}%,${l}%), hsl(180,${s}%,${l}%), hsl(240,${s}%,${l}%), hsl(300,${s}%,${l}%), hsl(360,${s}%,${l}%))`;
            // Saturation: grey ‚Üí vivid at current H and L
            document.getElementById('cp-sat').style.background =
                `linear-gradient(to right, hsl(${h},0%,${l}%), hsl(${h},100%,${l}%))`;
            // Lightness: black ‚Üí vivid ‚Üí white
            document.getElementById('cp-lit').style.background =
                `linear-gradient(to right, hsl(${h},${s}%,0%), hsl(${h},${s}%,50%), hsl(${h},${s}%,100%))`;
        }

        function applyPickerColor() {
            if (!activeColorKey) return;
            if (!currentTheme) {
                if (selectedThemeIndices.length > 0) {
                    currentTheme = { ...currentThemes[selectedThemeIndices[0]] };
                } else if (currentThemes.length > 0) {
                    currentTheme = { ...currentThemes[0] };
                } else return;
            }
            const hslValue = `hsl(${Math.round(cpH)}, ${Math.round(cpS)}%, ${Math.round(cpL)}%)`;
            currentTheme[activeColorKey] = hslValue;
            lockedProperties[activeColorKey] = hslValue;
            applyTheme(currentTheme);
            renderPropertyLocks();
            renderThemeGrid();
            const swatch = document.getElementById('swatch-' + activeColorKey);
            if (swatch) swatch.style.background = hslToHex(hslValue);
        }

        /* =============================================
           Font Picker
           ============================================= */
        const FONTS = [
            // Serif
            { name: 'Georgia',           stack: 'Georgia, serif',                              categories: ['serif'] },
            { name: 'Times New Roman',   stack: "'Times New Roman', serif",                    categories: ['serif'] },
            { name: 'Palatino',          stack: "'Palatino Linotype', Palatino, serif",        categories: ['serif'] },
            { name: 'Book Antiqua',      stack: "'Book Antiqua', Palatino, serif",             categories: ['serif'] },
            // Sans-serif
            { name: 'System UI',         stack: 'system-ui, sans-serif',                       categories: ['sans-serif'] },
            { name: 'Arial',             stack: 'Arial, sans-serif',                           categories: ['sans-serif'] },
            { name: 'Verdana',           stack: 'Verdana, sans-serif',                         categories: ['sans-serif', 'dyslexic'] },
            { name: 'Trebuchet MS',      stack: "'Trebuchet MS', sans-serif",                  categories: ['sans-serif'] },
            { name: 'Segoe UI',          stack: "'Segoe UI', Tahoma, sans-serif",              categories: ['sans-serif'] },
            { name: 'Tahoma',            stack: 'Tahoma, Geneva, sans-serif',                  categories: ['sans-serif'] },
            // Monospaced
            { name: 'Courier New',       stack: "'Courier New', monospace",                    categories: ['mono'] },
            { name: 'Consolas',          stack: 'Consolas, Monaco, monospace',                 categories: ['mono'] },
            { name: 'Lucida Console',    stack: "'Lucida Console', Monaco, monospace",         categories: ['mono'] },
            // Dyslexic-friendly
            { name: 'Lexend',            stack: "'Lexend', sans-serif",                        categories: ['dyslexic', 'sans-serif'] },
            { name: 'Atkinson Hyperlegible', stack: "'Atkinson Hyperlegible', sans-serif",     categories: ['dyslexic', 'sans-serif'] },
            { name: 'Comic Sans MS',     stack: "'Comic Sans MS', cursive",                    categories: ['dyslexic'] },
        ];

        let activeFontCategory = 'all';
        let currentFontStack = null;

        function openFontPicker() {
            const baseTheme = (lastSelectedThemeIndex !== null && currentThemes[lastSelectedThemeIndex])
                ? currentThemes[lastSelectedThemeIndex]
                : (selectedThemeIndices.length > 0 ? currentThemes[selectedThemeIndices[0]] : currentThemes[0]);
            currentFontStack = (lockedProperties.font !== undefined)
                ? lockedProperties.font
                : (baseTheme ? baseTheme.font : FONTS[0].stack);
            // Reset to All category
            setFontCategory('all');
            document.getElementById('font-picker-overlay').style.display = 'flex';
        }

        function closeFontPicker() {
            document.getElementById('font-picker-overlay').style.display = 'none';
        }

        function setFontCategory(cat) {
            activeFontCategory = cat;
            document.querySelectorAll('.fp-cat').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === cat);
            });
            renderFontList();
        }

        function renderFontList() {
            const list = document.getElementById('fp-font-list');
            const filtered = activeFontCategory === 'all'
                ? FONTS
                : FONTS.filter(f => f.categories.includes(activeFontCategory));

            list.innerHTML = filtered.map(f => {
                const isSelected = f.stack === currentFontStack;
                return `<button class="fp-font-btn${isSelected ? ' selected' : ''}"
                    style="font-family: ${f.stack}"
                    onclick="selectFont(${JSON.stringify(f.stack)}, ${JSON.stringify(f.name)})">
                    <span class="fp-font-name">${escapeHtml(f.name)}</span>
                    <span class="fp-font-sample">Aa Bb Cc ‚Äî The quick brown fox</span>
                </button>`;
            }).join('');
        }

        function selectFont(stack, name) {
            currentFontStack = stack;
            editProperty('font', stack);
            updateFontTrigger(stack, name);
            renderFontList();
        }

        function updateFontTrigger(stack, name) {
            const trigger = document.getElementById('font-pick-trigger');
            if (!trigger) return;
            const displayName = name
                || (FONTS.find(f => f.stack === stack) || {}).name
                || 'Font';
            trigger.textContent = displayName;
            trigger.style.fontFamily = stack || 'inherit';
        }

        function updateEditorValues() {
            // Use the most recently selected theme, or fall back to first selected, or first theme
            const baseTheme = (lastSelectedThemeIndex !== null && currentThemes[lastSelectedThemeIndex])
                ? currentThemes[lastSelectedThemeIndex]
                : (selectedThemeIndices.length > 0 ? currentThemes[selectedThemeIndices[0]] : currentThemes[0]);
            if (!baseTheme) return;

            // For each property, use locked value if locked, otherwise use the base theme's value
            const bgColor = lockedProperties.bgColor !== undefined ? lockedProperties.bgColor : baseTheme.bgColor;
            const textColor = lockedProperties.textColor !== undefined ? lockedProperties.textColor : baseTheme.textColor;
            const accentColor = lockedProperties.accentColor !== undefined ? lockedProperties.accentColor : baseTheme.accentColor;
            const borderRadius = lockedProperties.borderRadius !== undefined ? lockedProperties.borderRadius : baseTheme.borderRadius;
            const padding = lockedProperties.padding !== undefined ? lockedProperties.padding : baseTheme.padding;
            const font = lockedProperties.font !== undefined ? lockedProperties.font : baseTheme.font;

            const bgSwatch = document.getElementById('swatch-bgColor');
            const textSwatch = document.getElementById('swatch-textColor');
            const accentSwatch = document.getElementById('swatch-accentColor');
            if (bgSwatch) bgSwatch.style.background = hslToHex(bgColor);
            if (textSwatch) textSwatch.style.background = hslToHex(textColor);
            if (accentSwatch) accentSwatch.style.background = hslToHex(accentColor);
            document.getElementById('edit-radius').value = parseInt(borderRadius) || 12;
            document.getElementById('edit-padding').value = parseInt(padding) || 16;
            updateFontTrigger(font);
        }

        function confirmThemeSelection() {
            if (selectedThemeIndices.length === 0) {
                alert('Please select at least one theme');
                return;
            }

            if (selectedThemeIndices.length === 1) {
                // Single theme selected - apply and move to questions
                currentTheme = { ...currentThemes[selectedThemeIndices[0]] };
                // Apply any manually edited properties
                Object.keys(lockedProperties).forEach(key => {
                    currentTheme[key] = lockedProperties[key];
                });
                applyTheme(currentTheme);
                renderQuestions();
                backToQuestions();
                showView('entry');
            } else {
                // Multiple themes - generate children
                const selectedThemes = selectedThemeIndices.map(i => currentThemes[i]);
                themeHistory.push({ themes: currentThemes, selected: selectedThemeIndices, lastSelected: lastSelectedThemeIndex });
                currentThemes = generateChildThemes(selectedThemes);
                selectedThemeIndices = [];
                lastSelectedThemeIndex = null;

                // Apply first selected theme
                currentTheme = selectedThemes[0];
                applyTheme(currentTheme);

                renderThemeGrid();
                updateEditorValues();
                document.getElementById('back-themes-btn').style.display = 'inline-block';
                document.getElementById('theme-instruction').textContent = 'Refine your selection - pick themes you like';
            }
        }

        function goBackThemes() {
            if (themeHistory.length === 0) return;

            const previous = themeHistory.pop();
            currentThemes = previous.themes;
            selectedThemeIndices = previous.selected;
            lastSelectedThemeIndex = previous.lastSelected !== undefined ? previous.lastSelected : null;
            renderThemeGrid();
            updateEditorValues();

            if (themeHistory.length === 0) {
                document.getElementById('back-themes-btn').style.display = 'none';
                document.getElementById('theme-instruction').textContent = 'Select one or more themes that resonate with you';
            }
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            root.style.setProperty('--theme-bg', theme.bgColor);
            root.style.setProperty('--theme-text', theme.textColor);
            root.style.setProperty('--theme-accent', theme.accentColor);
            root.style.setProperty('--theme-border-radius', theme.borderRadius);
            root.style.setProperty('--theme-padding', theme.padding);
            root.style.setProperty('--theme-font', theme.font);

            // Font needs to be applied directly to body
            document.body.style.fontFamily = theme.font;
        }

        function initThemeSelection() {
            currentThemes = generateInitialThemes();
            selectedThemeIndices = [];
            themeHistory = [];
            currentTheme = null;
            lockedProperties = {};
            lastSelectedThemeIndex = null;
            renderThemeGrid();
            renderPropertyLocks();
            updateEditorValues();
            document.getElementById('back-themes-btn').style.display = 'none';
            document.getElementById('theme-instruction').textContent = 'Select one or more themes';
        }

        /* =============================================
           Questions & Answers
           ============================================= */
        function loadQuestions() {
            const stored = safeGetStorage(STORAGE_KEYS.QUESTIONS, null);
            if (stored) {
                questions = stored;
            } else {
                questions = [...defaultQuestions];
                saveQuestions();
            }
        }

        function saveQuestions() {
            safeSetStorage(STORAGE_KEYS.QUESTIONS, questions);
        }

        // Generate unique ID
        function generateId() {
            return 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize questions display
        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            currentAnswers = {};

            if (questions.length === 0) {
                container.innerHTML = '<p class="text-muted">No questions configured. Go to Edit Questions to add some.</p>';
                return;
            }

            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'question';

                let inputHtml = '';

                if (q.type === 'choice') {
                    inputHtml = `<div class="choices">
                        ${(q.options || []).map(opt =>
                            `<button class="choice-btn" data-question="${q.id}" data-value="${escapeHtml(opt)}" onclick="selectChoice(this)">${escapeHtml(opt)}</button>`
                        ).join('')}
                    </div>`;
                } else if (q.type === 'scale') {
                    const min = q.min || 1;
                    const max = q.max || 10;
                    const midValue = Math.floor((max - min) / 2) + min;
                    currentAnswers[q.id] = midValue;
                    inputHtml = `
                        <div class="scale-container">
                            <input type="range" min="${min}" max="${max}" value="${midValue}"
                                   data-question="${q.id}" onchange="updateScale(this)">
                            <span class="scale-value" id="scale-${q.id}">${midValue}</span>
                        </div>
                        <div class="scale-labels">
                            <span>${escapeHtml(q.minLabel) || min}</span>
                            <span>${escapeHtml(q.maxLabel) || max}</span>
                        </div>`;
                } else if (q.type === 'text') {
                    inputHtml = `<input type="text" data-question="${q.id}"
                                       placeholder="${escapeHtml(q.placeholder || '')}"
                                       onchange="updateText(this)">`;
                }

                div.innerHTML = `
                    <label class="question-label">${q.text}</label>
                    ${inputHtml}
                `;
                container.appendChild(div);
            });
        }

        function selectChoice(btn) {
            const questionId = btn.dataset.question;
            const value = btn.dataset.value;

            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(b => {
                b.classList.remove('selected');
            });

            btn.classList.add('selected');
            currentAnswers[questionId] = value;
        }

        function updateScale(input) {
            const questionId = input.dataset.question;
            currentAnswers[questionId] = parseInt(input.value);
            document.getElementById(`scale-${questionId}`).textContent = input.value;
        }

        function updateText(input) {
            const questionId = input.dataset.question;
            currentAnswers[questionId] = input.value;
        }

        function saveEntry() {
            const editor = document.getElementById('journal-text');
            const journalText = getPlainTextFromEditor(editor);

            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                answers: { ...currentAnswers },
                journal: journalText,
                theme: currentTheme
            };

            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            entries.unshift(entry);
            safeSetStorage(STORAGE_KEYS.ENTRIES, entries);

            const msg = document.getElementById('success-message');
            msg.classList.remove('hidden');
            setTimeout(() => {
                msg.classList.add('hidden');
                showView('landing');
            }, 2000);

            renderQuestions();
            editor.innerHTML = '';
        }

        function getPlainTextFromEditor(editor) {
            // Extract plain text with markdown from the contenteditable div
            return editor.innerText || '';
        }

        function handlePaste(event) {
            event.preventDefault();
            const text = event.clipboardData.getData('text/plain');
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function handleMarkdownInput() {
            // Debounce the expensive rendering operation
            if (markdownDebounceTimer) {
                clearTimeout(markdownDebounceTimer);
            }

            markdownDebounceTimer = setTimeout(() => {
                const editor = document.getElementById('journal-text');
                const selection = window.getSelection();

                // Save cursor position
                let cursorPos = 0;
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(editor);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    cursorPos = preCaretRange.toString().length;
                }

                // Get plain text content
                const text = editor.innerText || '';

                // Render markdown with styled syntax
                const html = renderMarkdownWithSyntax(text);
                editor.innerHTML = html;

                // Restore cursor position
                restoreCursor(editor, cursorPos);
            }, MARKDOWN_DEBOUNCE_MS);
        }

        function renderMarkdownWithSyntax(text) {
            if (!text) return '';

            let html = text;

            // Escape HTML
            html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Bold: **text** or __text__
            html = html.replace(/(\*\*|__)((?:(?!\1).)+)\1/g,
                '<span class="md-syntax">$1</span><span class="md-bold">$2</span><span class="md-syntax">$1</span>');

            // Italic: *text* or _text_ (but not ** or __)
            html = html.replace(/(?<!\*)\*(?!\*)([^*]+)\*(?!\*)/g,
                '<span class="md-syntax">*</span><span class="md-italic">$1</span><span class="md-syntax">*</span>');
            html = html.replace(/(?<!_)_(?!_)([^_]+)_(?!_)/g,
                '<span class="md-syntax">_</span><span class="md-italic">$1</span><span class="md-syntax">_</span>');

            // Inline code: `text`
            html = html.replace(/`([^`]+)`/g,
                '<span class="md-syntax">`</span><span class="md-code">$1</span><span class="md-syntax">`</span>');

            // Headings at start of line
            html = html.replace(/^(#{1,3})\s+(.+)$/gm,
                (match, hashes, content) => {
                    const level = hashes.length;
                    return `<span class="md-syntax">${hashes} </span><span class="md-heading h${level}">${content}</span>`;
                });

            // Convert newlines to <br> tags
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        function restoreCursor(element, position) {
            const selection = window.getSelection();
            const range = document.createRange();

            let currentPos = 0;
            let found = false;

            function searchNode(node) {
                if (found) return;

                if (node.nodeType === Node.TEXT_NODE) {
                    const nodeLength = node.textContent.length;
                    if (currentPos + nodeLength >= position) {
                        range.setStart(node, position - currentPos);
                        range.collapse(true);
                        found = true;
                        return;
                    }
                    currentPos += nodeLength;
                } else if (node.nodeName === 'BR') {
                    currentPos += 1;
                    if (currentPos >= position) {
                        range.setStartAfter(node);
                        range.collapse(true);
                        found = true;
                        return;
                    }
                } else {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        searchNode(node.childNodes[i]);
                        if (found) return;
                    }
                }
            }

            searchNode(element);

            if (found) {
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        /* =============================================
           Navigation & Views
           ============================================= */
        function startNewEntry() {
            initThemeSelection();
            showView('theme');
        }

        function goToJournal() {
            document.getElementById('questions-step').classList.add('hidden');
            document.getElementById('journal-step').classList.remove('hidden');
        }

        function backToQuestions() {
            document.getElementById('questions-step').classList.remove('hidden');
            document.getElementById('journal-step').classList.add('hidden');
        }

        function showView(view) {
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('theme-view').classList.add('hidden');
            document.getElementById('entry-view').classList.add('hidden');
            document.getElementById('history-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('questions-view').classList.add('hidden');
            document.getElementById('export-view').classList.add('hidden');

            if (view === 'landing') {
                document.getElementById('landing-view').classList.remove('hidden');
            } else if (view === 'theme') {
                document.getElementById('theme-view').classList.remove('hidden');
            } else if (view === 'entry') {
                document.getElementById('entry-view').classList.remove('hidden');
            } else if (view === 'history') {
                document.getElementById('history-view').classList.remove('hidden');
                renderHistory();
            } else if (view === 'detail') {
                document.getElementById('detail-view').classList.remove('hidden');
            } else if (view === 'questions') {
                document.getElementById('questions-view').classList.remove('hidden');
                renderQuestionsList();
            } else if (view === 'export') {
                document.getElementById('export-view').classList.remove('hidden');
            }
        }

        /* =============================================
           Entry History & Detail View
           ============================================= */
        function renderHistory() {
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            const container = document.getElementById('entries-list');

            if (entries.length === 0) {
                container.innerHTML = '<p class="text-muted">No entries yet. Start by creating your first entry!</p>';
                return;
            }

            container.innerHTML = entries.map(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const preview = entry.journal ? entry.journal.substring(0, 100) + (entry.journal.length > 100 ? '...' : '') : '(No journal text)';
                const name = entry.answers.name || 'Unknown';

                return `
                    <div class="entry-item" onclick="showEntryDetail(${entry.id})" style="cursor: pointer;">
                        <div class="entry-date">${escapeHtml(dateStr)}</div>
                        <div class="entry-answers">Name: ${escapeHtml(name)}</div>
                        <div class="entry-preview">${escapeHtml(preview)}</div>
                    </div>
                `;
            }).join('');
        }

        function showEntryDetail(id) {
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            const entry = entries.find(e => e.id === id);

            if (!entry) return;

            // Apply entry's theme if it has one
            if (entry.theme) {
                applyTheme(entry.theme);
            }

            const date = new Date(entry.timestamp);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

            // Try to match answers to current questions, fall back to raw display
            let answersHtml = '';
            for (const [key, value] of Object.entries(entry.answers)) {
                if (value === undefined || value === '') continue;
                const question = questions.find(q => q.id === key);
                const label = question ? question.text : key;
                answersHtml += `<p><strong>${escapeHtml(label)}</strong><br>${escapeHtml(value)}</p>`;
            }

            // Render markdown for journal (sanitized to prevent XSS)
            let journalHtml;
            if (entry.journal) {
                journalHtml = typeof marked !== 'undefined'
                    ? sanitizeHtml(marked.parse(entry.journal))
                    : '<pre>' + escapeHtml(entry.journal) + '</pre>';
            } else {
                journalHtml = '<p class="text-muted">(No journal text)</p>';
            }

            document.getElementById('entry-detail').innerHTML = `
                <div class="entry-date" style="font-size: 1rem; margin-bottom: 20px;">${dateStr}</div>
                <h3>Answers</h3>
                ${answersHtml || '<p class="text-muted">No answers recorded</p>'}
                <h3 style="margin-top: 24px;">Journal</h3>
                <div class="markdown-content">${journalHtml}</div>
                <button class="btn-danger" onclick="deleteEntry(${entry.id})" style="margin-top: 20px;">Delete Entry</button>
            `;

            showView('detail');
        }

        function deleteEntry(id) {
            showConfirm('Are you sure you want to delete this entry?', () => {
                let entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
                entries = entries.filter(e => e.id !== id);
                safeSetStorage(STORAGE_KEYS.ENTRIES, entries);
                showView('history');
            });
        }

        /* =============================================
           Questions Editor UI
           ============================================= */
        function renderQuestionsList() {
            const container = document.getElementById('questions-list');

            if (questions.length === 0) {
                container.innerHTML = '<p class="text-muted">No questions yet. Add your first question below.</p>';
                return;
            }

            container.innerHTML = questions.map((q, index) => {
                const typeLabel = q.type === 'scale' ? 'Scale' : q.type === 'choice' ? 'Multiple Choice' : 'Text';
                return `
                    <div class="question-card">
                        <div class="question-card-header">
                            <div class="question-card-title">${escapeHtml(q.text)}</div>
                            <span class="question-card-type">${typeLabel}</span>
                        </div>
                        <div class="question-card-actions">
                            ${index > 0 ? `<button class="btn-small" onclick="moveQuestion(${index}, -1)">Move Up</button>` : ''}
                            ${index < questions.length - 1 ? `<button class="btn-small" onclick="moveQuestion(${index}, 1)">Move Down</button>` : ''}
                            <button class="btn-small" onclick="editQuestion('${q.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteQuestion('${q.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function moveQuestion(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= questions.length) return;

            const temp = questions[index];
            questions[index] = questions[newIndex];
            questions[newIndex] = temp;

            saveQuestions();
            renderQuestionsList();
        }

        function openAddQuestionModal() {
            editingQuestionId = null;
            tempOptions = [];
            document.getElementById('modal-title').textContent = 'Add Question';
            document.getElementById('q-text').value = '';
            document.getElementById('q-type').value = 'text';
            document.getElementById('q-min').value = '1';
            document.getElementById('q-max').value = '10';
            document.getElementById('q-min-label').value = '';
            document.getElementById('q-max-label').value = '';
            document.getElementById('q-placeholder').value = '';
            updateTypeOptions();
            renderOptionsContainer();
            document.getElementById('question-modal').classList.remove('hidden');
        }

        function editQuestion(id) {
            const q = questions.find(x => x.id === id);
            if (!q) return;

            editingQuestionId = id;
            document.getElementById('modal-title').textContent = 'Edit Question';
            document.getElementById('q-text').value = q.text;
            document.getElementById('q-type').value = q.type;
            document.getElementById('q-min').value = q.min || 1;
            document.getElementById('q-max').value = q.max || 10;
            document.getElementById('q-min-label').value = q.minLabel || '';
            document.getElementById('q-max-label').value = q.maxLabel || '';
            document.getElementById('q-placeholder').value = q.placeholder || '';
            tempOptions = q.options ? [...q.options] : [];
            updateTypeOptions();
            renderOptionsContainer();
            document.getElementById('question-modal').classList.remove('hidden');
        }

        function closeQuestionModal() {
            document.getElementById('question-modal').classList.add('hidden');
            editingQuestionId = null;
            tempOptions = [];
        }

        function updateTypeOptions() {
            const type = document.getElementById('q-type').value;
            document.getElementById('scale-options').classList.toggle('hidden', type !== 'scale');
            document.getElementById('choice-options').classList.toggle('hidden', type !== 'choice');
            document.getElementById('text-options').classList.toggle('hidden', type !== 'text');
        }

        function renderOptionsContainer() {
            const container = document.getElementById('options-container');
            container.innerHTML = tempOptions.map((opt, i) => `
                <span class="option-tag">
                    ${escapeHtml(opt)}
                    <span class="option-remove" onclick="removeOption(${i})">x</span>
                </span>
            `).join('');
        }

        function addOption() {
            const input = document.getElementById('new-option');
            const value = input.value.trim();
            if (value && !tempOptions.includes(value)) {
                tempOptions.push(value);
                renderOptionsContainer();
                input.value = '';
            }
        }

        function removeOption(index) {
            tempOptions.splice(index, 1);
            renderOptionsContainer();
        }

        function saveQuestion() {
            const text = document.getElementById('q-text').value.trim();
            if (!text) {
                alert('Please enter a question text');
                return;
            }

            const type = document.getElementById('q-type').value;

            const question = {
                id: editingQuestionId || generateId(),
                text: text,
                type: type
            };

            if (type === 'scale') {
                question.min = parseInt(document.getElementById('q-min').value) || 1;
                question.max = parseInt(document.getElementById('q-max').value) || 10;
                question.minLabel = document.getElementById('q-min-label').value;
                question.maxLabel = document.getElementById('q-max-label').value;
            } else if (type === 'choice') {
                if (tempOptions.length < 2) {
                    alert('Please add at least 2 options for multiple choice');
                    return;
                }
                question.options = [...tempOptions];
            } else if (type === 'text') {
                question.placeholder = document.getElementById('q-placeholder').value;
            }

            if (editingQuestionId) {
                const index = questions.findIndex(q => q.id === editingQuestionId);
                if (index !== -1) {
                    questions[index] = question;
                }
            } else {
                questions.push(question);
            }

            saveQuestions();
            closeQuestionModal();
            renderQuestionsList();
        }

        function deleteQuestion(id) {
            showConfirm('Are you sure you want to delete this question?', () => {
                questions = questions.filter(q => q.id !== id);
                saveQuestions();
                renderQuestionsList();
            });
        }

        /* =============================================
           Export & Import
           ============================================= */
        function exportEntriesJSON() {
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            downloadJSON(entries, 'wetrack-entries.json');
        }

        function exportQuestionsJSON() {
            downloadJSON(questions, 'wetrack-questions.json');
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportEntriesCSV() {
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }

            // Gather all possible answer keys
            const allKeys = new Set();
            entries.forEach(e => {
                Object.keys(e.answers || {}).forEach(k => allKeys.add(k));
            });
            const answerKeys = Array.from(allKeys).sort();

            // Build CSV header
            const headers = ['id', 'timestamp', ...answerKeys, 'journal'];

            // Helper to escape CSV cell values (handles quotes, newlines, commas)
            function escapeCsvCell(val) {
                if (val === undefined || val === null) return '';
                const str = String(val);
                // Escape double quotes by doubling them, wrap in quotes
                return str.replace(/"/g, '""');
            }

            // Build rows
            const rows = entries.map(e => {
                const row = [
                    e.id,
                    e.timestamp,
                    ...answerKeys.map(k => escapeCsvCell(e.answers[k])),
                    escapeCsvCell(e.journal || '')
                ];
                // Always wrap in quotes to handle newlines and commas within values
                return row.map(cell => `"${cell}"`).join(',');
            });

            const csv = [headers.map(h => `"${h}"`).join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wetrack-entries.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importEntriesJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        alert('Invalid format: expected an array of entries');
                        return;
                    }

                    const existing = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
                    const existingIds = new Set(existing.map(e => e.id));

                    let imported = 0;
                    let skipped = 0;
                    data.forEach(entry => {
                        // Validate required fields
                        if (!entry.id || !entry.timestamp) {
                            skipped++;
                            return;
                        }
                        if (existingIds.has(entry.id)) {
                            return; // Already exists, not an error
                        }
                        // Ensure required structure exists with defaults
                        const validatedEntry = {
                            id: entry.id,
                            timestamp: entry.timestamp,
                            answers: entry.answers && typeof entry.answers === 'object' ? entry.answers : {},
                            journal: typeof entry.journal === 'string' ? entry.journal : '',
                            theme: entry.theme || null
                        };
                        existing.push(validatedEntry);
                        imported++;
                    });

                    existing.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    safeSetStorage(STORAGE_KEYS.ENTRIES, existing);
                    let message = `Imported ${imported} new entries`;
                    if (skipped > 0) {
                        message += ` (${skipped} skipped due to missing required fields)`;
                    }
                    alert(message);
                    event.target.value = '';
                } catch (err) {
                    alert('Error parsing file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function importQuestionsJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        alert('Invalid format: expected an array of questions');
                        return;
                    }

                    if (!confirm('This will replace all current questions. Continue?')) {
                        return;
                    }

                    questions = data;
                    saveQuestions();
                    alert('Questions imported successfully');
                    event.target.value = '';
                    renderQuestionsList();
                } catch (err) {
                    alert('Error parsing file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        /* =============================================
           Initialization
           ============================================= */
        function loadLastEntryTheme() {
            const entries = safeGetStorage(STORAGE_KEYS.ENTRIES, []);
            if (entries.length > 0 && entries[0].theme) {
                applyTheme(entries[0].theme);
            }
        }

        // Run on page load
        loadQuestions();
        renderQuestions();
        loadLastEntryTheme();
    </script>

    <!-- Font picker modal -->
    <div id="font-picker-overlay" onclick="if(event.target===this)closeFontPicker()">
        <div id="font-picker-panel" onclick="event.stopPropagation()">
            <h3 id="fp-title">Font</h3>
            <div id="fp-categories">
                <button class="fp-cat active" data-cat="all" onclick="setFontCategory('all')">All</button>
                <button class="fp-cat" data-cat="serif" onclick="setFontCategory('serif')">Serif</button>
                <button class="fp-cat" data-cat="sans-serif" onclick="setFontCategory('sans-serif')">Sans-Serif</button>
                <button class="fp-cat" data-cat="mono" onclick="setFontCategory('mono')">Mono</button>
                <button class="fp-cat" data-cat="dyslexic" onclick="setFontCategory('dyslexic')">Dyslexic-friendly</button>
            </div>
            <div id="fp-font-list"></div>
            <button id="fp-done" onclick="closeFontPicker()">Done</button>
        </div>
    </div>

    <!-- Custom colour picker modal -->
    <div id="color-picker-overlay" onclick="if(event.target===this)closeColorPicker()">
        <div id="color-picker-panel" onclick="event.stopPropagation()">
            <h3 id="cp-title">Colour</h3>
            <div id="cp-preview"></div>

            <div class="cp-row">
                <span class="cp-label">H</span>
                <input type="range" id="cp-hue" min="0" max="360" oninput="updateColorFromSliders()">
                <input type="number" id="cp-hue-num" min="0" max="360" oninput="updateColorFromNumbers()">
            </div>
            <div class="cp-row">
                <span class="cp-label">S</span>
                <input type="range" id="cp-sat" min="0" max="100" oninput="updateColorFromSliders()">
                <input type="number" id="cp-sat-num" min="0" max="100" oninput="updateColorFromNumbers()">
            </div>
            <div class="cp-row">
                <span class="cp-label">L</span>
                <input type="range" id="cp-lit" min="0" max="100" oninput="updateColorFromSliders()">
                <input type="number" id="cp-lit-num" min="0" max="100" oninput="updateColorFromNumbers()">
            </div>

            <div class="cp-hex-row">
                <span class="cp-label">#</span>
                <input type="text" id="cp-hex" maxlength="7" placeholder="#rrggbb" oninput="updateColorFromHex()">
            </div>

            <button id="cp-done" onclick="closeColorPicker()">Done</button>
        </div>
    </div>
</body>
</html>
